name: bookstore 
on: push 
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: get the code
              uses: actions/checkout@v3

            - name: Setup .NET SDK
              uses: actions/setup-dotnet@v3
              with:
                dotnet-version: 7

            - name: Setup Node.js
              uses: actions/setup-node@v2
        #   with:
        #     node-version: 14

            # - name: Install Yarn
            #   run: npm install -g yarn

            - name: Install dependencies
              run: dotnet restore

            - name: Build
              run: dotnet build --configuration Release --no-restore

            # - name: Run 
            #   run: dotnet run 
              #having isshu in this command 

            - name: Test
              run: dotnet test --no-restore --verbosity normal
              

    deplpy: 
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: get the code
              uses: actions/checkout@v3

            - name: Set up Docker
              uses: docker/setup-buildx-action@v1

            - name: Configure AWS CLI
              run: | 
                aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws configure set region ap-south-1

            - name: Login to Amazon ECR
              run: |
                aws --version
                aws ecr get-login-password --region ap-south-1 | docker login -u AWS -p -p $(aws ecr get-login-password --region the-region-you-are-in) 177501120181.dkr.ecr.ap-south-1.amazonaws.com
            
            - name: Build the docker image
              run: docker build -t dotnet-application . 
            
            - name: Tag docker image
              run: docker tag dotnet-application:latest 177501120181.dkr.ecr.ap-south-1.amazonaws.com/dotnet-application:latest
            
            - name: Push image to ECR
              run: docker push 177501120181.dkr.ecr.ap-south-1.amazonaws.com/dotnet-application:latest




